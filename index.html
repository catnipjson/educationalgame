<!DOCTYPE html>
<html>
<head>
  <title>2D FPS Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #111;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: #222;
      touch-action: none;
    }
  </style>
</head>
<body>
  <canvas id="game" width="800" height="600"></canvas>
  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const player = { x: 100, y: 100, size: 20, speed: 3, hp: 100 };
    const enemy = { x: 600, y: 400, size: 20, speed: 2, hp: 100, cooldown: 0 };
    const bullets = [];
    const walls = [
      { x: 300, y: 200, w: 100, h: 20 },
      { x: 500, y: 300, w: 20, h: 100 },
      { x: 200, y: 400, w: 150, h: 20 }
    ];

    let keys = {};
    let touchMove = { dx: 0, dy: 0 };

    document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
    document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

    // Touch movement: drag to move
    let touchStart = null;
    canvas.addEventListener("touchstart", e => {
      if (e.touches.length === 1) {
        touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
      }
    });
    canvas.addEventListener("touchmove", e => {
      if (e.touches.length === 1 && touchStart) {
        const dx = e.touches[0].clientX - touchStart.x;
        const dy = e.touches[0].clientY - touchStart.y;
        const mag = Math.hypot(dx, dy);
        touchMove.dx = mag > 10 ? dx / mag : 0;
        touchMove.dy = mag > 10 ? dy / mag : 0;
      }
    });
    canvas.addEventListener("touchend", e => {
      touchMove = { dx: 0, dy: 0 };
      touchStart = null;
    });

    // Touch shooting: tap to shoot
    canvas.addEventListener("touchstart", e => {
      if (e.touches.length === 1 && enemy.hp > 0 && player.hp > 0) {
        const angle = Math.atan2(enemy.y - player.y, enemy.x - player.x);
        shoot(player, angle, "player");
      }
    });

    canvas.addEventListener("click", e => {
      const angle = Math.atan2(e.offsetY - player.y, e.offsetX - player.x);
      shoot(player, angle, "player");
    });

    function shoot(from, angle, owner) {
      bullets.push({
        x: from.x,
        y: from.y,
        dx: Math.cos(angle) * 6,
        dy: Math.sin(angle) * 6,
        owner: owner
      });
    }

    function move(obj, dx, dy) {
      obj.x += dx;
      obj.y += dy;
      for (let wall of walls) {
        if (
          obj.x > wall.x - obj.size &&
          obj.x < wall.x + wall.w + obj.size &&
          obj.y > wall.y - obj.size &&
          obj.y < wall.y + wall.h + obj.size
        ) {
          obj.x -= dx;
          obj.y -= dy;
        }
      }
    }

    function update() {
      // Move player (keyboard or touch)
      let dx = (keys["d"] ? 1 : 0) - (keys["a"] ? 1 : 0) + touchMove.dx;
      let dy = (keys["s"] ? 1 : 0) - (keys["w"] ? 1 : 0) + touchMove.dy;
      const mag = Math.hypot(dx, dy);
      if (mag > 0) move(player, (dx / mag) * player.speed, (dy / mag) * player.speed);

      // Enemy AI
      if (!lineBlocked(enemy.x, enemy.y, player.x, player.y)) {
        if (enemy.cooldown <= 0) {
          const angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
          shoot(enemy, angle, "enemy");
          enemy.cooldown = 60;
        }
      } else {
        const angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
        move(enemy, Math.cos(angle) * enemy.speed, Math.sin(angle) * enemy.speed);
      }

      enemy.cooldown = Math.max(0, enemy.cooldown - 1);

      // Update bullets
      for (let i = bullets.length - 1; i >= 0; i--) {
        const b = bullets[i];
        b.x += b.dx;
        b.y += b.dy;

        // Hit wall
        if (walls.some(w => b.x > w.x && b.x < w.x + w.w && b.y > w.y && b.y < w.y + w.h)) {
          bullets.splice(i, 1);
          continue;
        }

        // Hit enemy/player
        if (b.owner === "player" && Math.hypot(b.x - enemy.x, b.y - enemy.y) < enemy.size) {
          enemy.hp -= 15;
          bullets.splice(i, 1);
        } else if (b.owner === "enemy" && Math.hypot(b.x - player.x, b.y - player.y) < player.size) {
          player.hp -= 15;
          bullets.splice(i, 1);
        }
      }
    }

    function lineBlocked(x1, y1, x2, y2) {
      for (let wall of walls) {
        if (lineRectIntersect(x1, y1, x2, y2, wall)) return true;
      }
      return false;
    }

    function lineRectIntersect(x1, y1, x2, y2, r) {
      const { x, y, w, h } = r;
      return (
        lineLine(x1, y1, x2, y2, x, y, x + w, y) ||
        lineLine(x1, y1, x2, y2, x + w, y, x + w, y + h) ||
        lineLine(x1, y1, x2, y2, x + w, y + h, x, y + h) ||
        lineLine(x1, y1, x2, y2, x, y + h, x, y)
      );
    }

    function lineLine(x1, y1, x2, y2, x3, y3, x4, y4) {
      const den = (x1 - x2) * (y3 - y4) - (y1 - y2) * (x3 - x4);
      if (den === 0) return false;
      const t = ((x1 - x3) * (y3 - y4) - (y1 - y3) * (x3 - x4)) / den;
      const u = -((x1 - x2) * (y1 - x3) - (y1 - y2) * (x1 - x3)) / den;
      return t >= 0 && t <= 1 && u >= 0 && u <= 1;
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Walls
      ctx.fillStyle = "gray";
      for (let wall of walls) {
        ctx.fillRect(wall.x, wall.y, wall.w, wall.h);
      }

      // Player
      ctx.fillStyle = "lime";
      ctx.beginPath();
      ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
      ctx.fill();

      // Enemy
      ctx.fillStyle = "red";
      ctx.beginPath();
      ctx.arc(enemy.x, enemy.y, enemy.size, 0, Math.PI * 2);
      ctx.fill();

      // Bullets
      ctx.fillStyle = "white";
      for (let b of bullets) {
        ctx.beginPath();
        ctx.arc(b.x, b.y, 4, 0, Math.PI * 2);
        ctx.fill();
      }

      // Text
      ctx.fillStyle = "white";
      ctx.fillText(`Player HP: ${player.hp}`, 10, 20);
      ctx.fillText(`Enemy HP: ${enemy.hp}`, 680, 20);

      if (player.hp <= 0) ctx.fillText("YOU DIED", 370, 300);
      if (enemy.hp <= 0) ctx.fillText("ENEMY DEFEATED", 340, 300);
    }

    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }

    loop();
  </script>
</body>
</html>
